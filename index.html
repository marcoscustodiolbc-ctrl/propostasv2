<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acompanhamento de Propostas</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const { useState, useEffect } = React;
        const e = React.createElement;
        
        function ProposalTracker() {
            const [csvData, setCsvData] = useState([]);
            const [storeMap, setStoreMap] = useState({});
            const [gcmMap, setGcmMap] = useState({});
            const [fileName, setFileName] = useState('');
            const [storeFileName, setStoreFileName] = useState('');
            const [observations, setObservations] = useState({});
            const [savedPages, setSavedPages] = useState({});
            const [selectedPage, setSelectedPage] = useState(null);
            const [debugInfo, setDebugInfo] = useState('');
            const [filterGcm, setFilterGcm] = useState('todos');
            const [filterStatus, setFilterStatus] = useState('todos');

            useEffect(() => {
                loadFromCache();
            }, []);

            const loadFromCache = () => {
                try {
                    const cached = localStorage.getItem('proposalTrackerData');
                    if (cached) {
                        const data = JSON.parse(cached);
                        setCsvData(data.csvData || []);
                        setStoreMap(data.storeMap || {});
                        setGcmMap(data.gcmMap || {});
                        setFileName(data.fileName || '');
                        setStoreFileName(data.storeFileName || '');
                        setObservations(data.observations || {});
                        setSavedPages(data.savedPages || {});
                    }
                } catch (error) {
                    console.error('Erro ao carregar:', error);
                }
            };

            const saveToCache = () => {
                localStorage.setItem('proposalTrackerData', JSON.stringify({
                    csvData, storeMap, gcmMap, fileName, storeFileName, observations, savedPages
                }));
            };

            const parseCSV = (text) => {
                const lines = text.split('\n').filter(l => l.trim());
                if (!lines.length) return [];
                const sep = lines[0].includes(';') && lines[0].split(';').length > lines[0].split(',').length ? ';' : ',';
                return lines.slice(1).map((line, idx) => {
                    const values = [];
                    let current = '', inQuotes = false;
                    for (let char of line) {
                        if (char === '"') inQuotes = !inQuotes;
                        else if (char === sep && !inQuotes) { values.push(current.trim()); current = ''; }
                        else current += char;
                    }
                    values.push(current.trim());
                    return { id: idx, values };
                });
            };

            const handleStoreUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = parseCSV(evt.target.result);
                    const mapL = {}, mapG = {};
                    let count = 0;
                    data.forEach(r => {
                        const dn = (r.values[0] || '').toString().trim().replace(/"/g, '').replace(/\s/g, '');
                        const nome = (r.values[1] || '').toString().trim().replace(/"/g, '');
                        const gcm = (r.values[2] || '').toString().trim().replace(/"/g, '');
                        if (dn && nome) { mapL[dn] = nome; mapG[dn] = gcm; count++; }
                    });
                    setStoreMap(mapL);
                    setGcmMap(mapG);
                    setStoreFileName(file.name);
                    setDebugInfo(`‚úÖ ${count} lojas carregadas!`);
                    setTimeout(() => setDebugInfo(''), 3000);
                    saveToCache();
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const handleCsvUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!Object.keys(storeMap).length) { alert('‚ö†Ô∏è Carregue a planilha de lojas primeiro!'); return; }
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = parseCSV(evt.target.result);
                    setCsvData(data);
                    setFileName(file.name);
                    setObservations({});
                    setSelectedPage(null);
                    saveToCache();
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            const lookupGcm = (dn) => {
                if (!dn || !Object.keys(gcmMap).length) return '';
                const clean = dn.toString().trim().replace(/"/g, '').replace(/\s/g, '');
                return gcmMap[clean] || gcmMap[Object.keys(gcmMap).find(k => k.toLowerCase() === clean.toLowerCase())] || '';
            };

            const lookupStore = (dn) => {
                if (!dn || !Object.keys(storeMap).length) return '';
                const clean = dn.toString().trim().replace(/"/g, '').replace(/\s/g, '');
                return storeMap[clean] || storeMap[Object.keys(storeMap).find(k => k.toLowerCase() === clean.toLowerCase())] || '‚úó';
            };

            const getRowColor = (row) => {
                const status = (row.values[21] || '').replace(/"/g, '').toLowerCase();
                if (status.includes('aprovad')) return 'bg-green-100 border-l-4 border-green-500';
                if (status.includes('recusad')) return 'bg-red-100 border-l-4 border-red-500';
                return 'bg-white';
            };

            const getFilteredData = () => {
                let filtered = [...csvData];
                if (filterStatus === 'aprovada') filtered = filtered.filter(r => (r.values[21] || '').toLowerCase().includes('aprovad'));
                else if (filterStatus === 'recusada') filtered = filtered.filter(r => (r.values[21] || '').toLowerCase().includes('recusad'));
                if (filterGcm !== 'todos') filtered = filtered.filter(r => lookupGcm(r.values[5]) === filterGcm);
                return filtered;
            };

            const getUniqueGcms = () => {
                const gcms = new Set();
                csvData.forEach(r => { const g = lookupGcm(r.values[5]); if (g) gcms.add(g); });
                return Array.from(gcms).sort();
            };

            const calculateStats = () => {
                const data = getFilteredData();
                const total = data.length;
                let aprov = 0, recus = 0;
                data.forEach(r => {
                    const s = (r.values[21] || '').toLowerCase();
                    if (s.includes('aprovad')) aprov++;
                    if (s.includes('recusad')) recus++;
                });
                const pA = total > 0 ? ((aprov / total) * 100).toFixed(1) : 0;
                const pR = total > 0 ? ((recus / total) * 100).toFixed(1) : 0;
                return { total, aprovadas: aprov, recusadas: recus, percAprovadas: pA, percRecusadas: pR };
            };

            const updateObs = (id, val) => {
                const newObs = { ...observations, [id]: val };
                setObservations(newObs);
                saveToCache();
            };

            const savePage = () => {
                if (!csvData.length) { alert('‚ùå Nenhum dado para salvar!'); return; }
                const now = new Date();
                const name = `${now.toLocaleDateString('pt-BR')} - ${now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
                const newPages = { ...savedPages, [name]: { data: csvData, observations, fileName, savedAt: now.toISOString(), gcmMap, storeMap } };
                setSavedPages(newPages);
                saveToCache();
                alert(`‚úÖ P√°gina "${name}" salva!`);
                setCsvData([]);
                setFileName('');
                setObservations({});
                setSelectedPage(null);
                setFilterGcm('todos');
                setFilterStatus('todos');
            };

            const loadPage = (name) => {
                const page = savedPages[name];
                if (page) {
                    setCsvData(page.data);
                    setObservations(page.observations || {});
                    setFileName(page.fileName || name);
                    setSelectedPage(name);
                    setFilterGcm('todos');
                    setFilterStatus('todos');
                    if (page.gcmMap) setGcmMap(page.gcmMap);
                    if (page.storeMap) setStoreMap(page.storeMap);
                }
            };

            const deletePage = (name) => {
                if (confirm(`Excluir "${name}"?`)) {
                    const newPages = { ...savedPages };
                    delete newPages[name];
                    setSavedPages(newPages);
                    saveToCache();
                    if (selectedPage === name) {
                        setCsvData([]);
                        setFileName('');
                        setObservations({});
                        setSelectedPage(null);
                    }
                }
            };

            const stats = calculateStats();
            const filtered = getFilteredData();

            return e('div', { className: 'min-h-screen bg-green-50' },
                e('div', { className: 'bg-green-600 text-white py-6 shadow-lg' },
                    e('div', { className: 'container mx-auto px-4' },
                        e('h1', { className: 'text-3xl font-bold text-center' }, 'üìä Acompanhamento de Propostas')
                    )
                ),
                
                e('div', { className: 'container mx-auto px-4 py-4' },
                    e('div', { className: 'flex justify-center gap-4' },
                        e('label', { className: 'bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg cursor-pointer flex items-center gap-2 transition shadow-md' },
                            'üì§ ', storeFileName || 'Upload - Lista de Lojas CSV',
                            e('input', { type: 'file', accept: '.csv', onChange: handleStoreUpload, className: 'hidden' })
                        )
                    ),
                    debugInfo && e('div', { className: 'mt-4 bg-green-100 border-2 border-green-400 rounded-lg p-3 max-w-md mx-auto text-center' },
                        e('p', { className: 'text-green-800 font-semibold' }, debugInfo)
                    ),
                    Object.keys(storeMap).length > 0 && !debugInfo && e('p', { className: 'text-center text-green-700 mt-2 font-semibold' },
                        `‚úÖ ${Object.keys(storeMap).length} lojas mapeadas`
                    )
                ),

                Object.keys(savedPages).length > 0 && e('div', { className: 'container mx-auto px-4 mb-4' },
                    e('div', { className: 'bg-white p-4 rounded-lg shadow-lg border-2 border-green-400' },
                        e('div', { className: 'flex items-center gap-2 mb-3' },
                            e('h3', { className: 'font-bold text-green-800' }, 'üìÅ P√°ginas Salvas')
                        ),
                        e('div', { className: 'flex flex-wrap gap-2' },
                            Object.keys(savedPages).sort().reverse().map(name => {
                                const date = name.split(' - ')[0];
                                return e('div', { key: name, className: 'flex items-center gap-1 bg-green-50 rounded-lg p-1 border border-green-300' },
                                    e('button', {
                                        onClick: () => loadPage(name),
                                        className: `px-4 py-2 rounded-lg transition font-semibold ${selectedPage === name ? 'bg-green-600 text-white' : 'bg-white hover:bg-green-100 text-green-800'}`
                                    }, date),
                                    e('button', {
                                        onClick: () => deletePage(name),
                                        className: 'bg-red-500 hover:bg-red-600 text-white px-2 py-2 rounded transition',
                                        title: 'Excluir'
                                    }, 'üóëÔ∏è')
                                );
                            })
                        )
                    )
                ),

                e('div', { className: 'container mx-auto px-4 pb-8' },
                    csvData.length > 0 ? e('div', null,
                        e('div', { className: 'mb-4' },
                            e('div', { className: 'flex gap-3 justify-center items-center' },
                                (filterGcm !== 'todos' || filterStatus !== 'todos') && e('div', { className: 'text-sm font-semibold text-purple-700 bg-purple-50 px-3 py-1 rounded border border-purple-300' }, 'üìä Filtrado'),
                                e('div', { className: 'bg-blue-100 px-4 py-2 rounded-lg text-center border-2 border-blue-300' },
                                    e('div', { className: 'text-2xl font-bold text-blue-600' }, stats.total),
                                    e('div', { className: 'text-xs text-blue-800 font-semibold' }, 'Total')
                                ),
                                e('div', { className: 'bg-green-100 px-4 py-2 rounded-lg text-center border-2 border-green-400' },
                                    e('div', { className: 'text-2xl font-bold text-green-600' },
                                        stats.aprovadas, ' ', e('span', { className: 'text-lg' }, `(${stats.percAprovadas}%)`)
                                    ),
                                    e('div', { className: 'text-xs text-green-800 font-semibold' }, 'Aprovadas')
                                ),
                                e('div', { className: 'bg-red-100 px-4 py-2 rounded-lg text-center border-2 border-red-400' },
                                    e('div', { className: 'text-2xl font-bold text-red-600' },
                                        stats.recusadas, ' ', e('span', { className: 'text-lg' }, `(${stats.percRecusadas}%)`)
                                    ),
                                    e('div', { className: 'text-xs text-red-800 font-semibold' }, 'Recusadas')
                                )
                            )
                        ),

                        e('div', { className: 'bg-white p-4 rounded-lg shadow-md border-2 border-green-300 mb-4' },
                            e('h3', { className: 'font-bold text-green-800 mb-3' }, 'üîç Filtros'),
                            e('div', { className: 'flex flex-wrap items-center gap-4' },
                                e('div', null,
                                    e('label', { className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'Status:'),
                                    e('select', {
                                        value: filterStatus,
                                        onChange: (ev) => setFilterStatus(ev.target.value),
                                        className: 'px-4 py-2 border-2 border-green-300 rounded-lg focus:border-green-500 outline-none font-medium'
                                    },
                                        e('option', { value: 'todos' }, 'Todos'),
                                        e('option', { value: 'aprovada' }, '‚úÖ Aprovadas'),
                                        e('option', { value: 'recusada' }, '‚ùå Recusadas')
                                    )
                                ),
                                e('div', null,
                                    e('label', { className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'GCM:'),
                                    e('select', {
                                        value: filterGcm,
                                        onChange: (ev) => setFilterGcm(ev.target.value),
                                        className: 'px-4 py-2 border-2 border-green-300 rounded-lg focus:border-green-500 outline-none font-medium min-w-[200px]'
                                    },
                                        e('option', { value: 'todos' }, 'Todos os GCMs'),
                                        getUniqueGcms().map(g => e('option', { key: g, value: g }, g))
                                    )
                                ),
                                (filterGcm !== 'todos' || filterStatus !== 'todos') && e('div', { className: 'flex items-end' },
                                    e('button', {
                                        onClick: () => { setFilterGcm('todos'); setFilterStatus('todos'); },
                                        className: 'px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-semibold'
                                    }, 'Limpar Filtros')
                                ),
                                e('div', { className: 'ml-auto text-sm text-gray-600' },
                                    'Mostrando: ', e('span', { className: 'font-bold text-green-700' }, filtered.length), ' de ', csvData.length, ' registros'
                                )
                            )
                        ),

                        e('div', { className: 'bg-white rounded-lg shadow-lg overflow-hidden border-2 border-green-300' },
                            e('div', { className: 'overflow-x-auto' },
                                e('table', { className: 'w-full' },
                                    e('thead', { className: 'bg-green-600 text-white' },
                                        e('tr', null,
                                            e('th', { className: 'px-4 py-3 text-left' }, 'Nome'),
                                            e('th', { className: 'px-4 py-3 text-left' }, 'Propostas'),
                                            e('th', { className: 'px-4 py-3 text-left' }, 'Data'),
                                            e('th', { className: 'px-4 py-3 text-left' }, 'Status'),
                                            e('th', { className: 'px-4 py-3 text-left' }, 'DN'),
                                            e('th', { className: 'px-4 py-3 text-left' }, 'Loja'),
                                            e('th', { className: 'px-4 py-3 text-left' }, 'GCM'),
                                            e('th', { className: 'px-4 py-3 text-left' }, 'Observa√ß√£o')
                                        )
                                    ),
                                    e('tbody', null,
                                        filtered.map(row => e('tr', { key: row.id, className: `border-b ${getRowColor(row)}` },
                                            e('td', { className: 'px-4 py-3 text-sm' }, (row.values[2] || '').replace(/"/g, '')),
                                            e('td', { className: 'px-4 py-3 text-sm' }, (row.values[6] || '').replace(/"/g, '')),
                                            e('td', { className: 'px-4 py-3 text-sm' }, (row.values[8] || '').replace(/"/g, '')),
                                            e('td', { className: 'px-4 py-3 text-sm font-semibold' }, (row.values[21] || '').replace(/"/g, '')),
                                            e('td', { className: 'px-4 py-3 text-sm' }, (row.values[5] || '').replace(/"/g, '')),
                                            e('td', { className: 'px-4 py-3 text-sm font-medium text-blue-700' }, lookupStore(row.values[5])),
                                            e('td', { className: 'px-4 py-3 text-sm font-medium text-purple-700' }, lookupGcm(row.values[5])),
                                            e('td', { className: 'px-4 py-3' },
                                                e('input', {
                                                    type: 'text',
                                                    value: observations[row.id] || '',
                                                    onChange: (ev) => updateObs(row.id, ev.target.value),
                                                    className: 'w-full px-3 py-2 border-2 border-green-300 rounded focus:border-green-500 focus:outline-none',
                                                    placeholder: 'Observa√ß√µes...'
                                                })
                                            )
                                        ))
                                    )
                                )
                            ),
                            !selectedPage && e('div', { className: 'bg-green-50 p-4 border-t-2 border-green-300 flex justify-between items-center' },
                                e('button', {
                                    onClick: savePage,
                                    className: 'bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 shadow-md font-semibold transition'
                                }, 'üíæ Salvar P√°gina Atual'),
                                e('div', { className: 'text-sm text-gray-600' }, 'Salve esta p√°gina para consultar depois')
                            ),
                            selectedPage && e('div', { className: 'bg-blue-50 p-4 border-t-2 border-blue-300 flex justify-between items-center' },
                                e('div', { className: 'flex items-center gap-3' },
                                    e('span', { className: 'text-blue-700 font-semibold' },
                                        'üëÅÔ∏è Visualizando: ', e('span', { className: 'font-bold' }, selectedPage)
                                    )
                                ),
                                e('button', {
                                    onClick: () => {
                                        setCsvData([]);
                                        setFileName('');
                                        setObservations({});
                                        setSelectedPage(null);
                                        setFilterGcm('todos');
                                        setFilterStatus('todos');
                                    },
                                    className: 'bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg font-semibold transition'
                                }, '‚úñÔ∏è Fechar Visualiza√ß√£o')
                            )
                        )
                    ) : e('div', { className: 'bg-white rounded-lg shadow-lg p-12 text-center border-2 border-green-300' },
                        e('h3', { className: 'text-xl font-bold text-gray-700 mb-2' }, 'Como usar:'),
                        e('ol', { className: 'text-left max-w-md mx-auto space-y-2 text-gray-700' },
                            e('li', null, '1Ô∏è‚É£ Upload da Lista de Lojas (CSV)'),
                            e('li', null, '2Ô∏è‚É£ Upload do CSV de Propostas'),
                            e('li', null, '3Ô∏è‚É£ Preencha observa√ß√µes'),
                            e('li', null, '4Ô∏è‚É£ Salve a p√°gina')
                        )
                    )
                ),

                e('div', { className: 'bg-green-600 py-6' },
                    e('div', { className: 'container mx-auto px-4' },
                        e('div', { className: 'flex flex-wrap justify-center items-center gap-4 mb-4' },
                            e('label', { className: 'bg-green-700 hover:bg-green-800 text-white px-6 py-3 rounded-lg cursor-pointer flex items-center gap-2 shadow-md' },
                                'üì§ ', fileName || 'Upload CSV - Propostas',
                                e('input', { type: 'file', accept: '.csv', onChange: handleCsvUpload, className: 'hidden' })
                            )
                        ),
                        e('div', { className: 'text-center' },
                            e('p', { className: 'text-green-100 text-sm' },
                                'developed by ', e('span', { className: 'font-bold' }, '@marcosacustodio')
                            )
                        )
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(e(ProposalTracker));
    </script>
</body>
</html>